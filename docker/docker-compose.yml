version: '3.1'
services:

  db:
    hostname: db
    container_name: db
    image: postgres:13
    environment:
      - POSTGRES_PASSWORD=odoo
      - POSTGRES_USER=odoo
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/postgresql/data

  odoo:
    hostname: odoo-${ODOO_VERSION:-15.0}
    container_name: odoo-${ODOO_VERSION:-15.0}
    depends_on:
      - db
    image: odoopbx/odoo:${ODOO_VERSION:-15.0}
    command: odoo -d odoopbx_${ODOO_VERSION:-15.0}
    environment:
    - HOST=db
    - USER=odoo
    - PASSWORD=odoo
    volumes:
      - odoo_data:/var/lib/odoo
    ports:
      # Odoo HTTP longpolling port http://localhost:8072/web
      - 0.0.0.0:8072:8072/tcp
      - 0.0.0.0:8069:8069/tcp

  pbx:
    hostname: pbx
    container_name: pbx
    image: odoopbx/pbx
    # --network=host is recommended for Asterisk
    network_mode: host
    # Privileged mode required to manage host's ipsets and iptables
    privileged: true
    volumes:
      - asterisk_etc:/etc/asterisk
      - ./odoopbx:/etc/salt/odoopbx
    environment:
      - ODOO_URL=http://127.0.0.1:8069/?db=odoopbx_${ODOO_VERSION:-15.0}


volumes:
  odoo_data:
  db_data:
  asterisk_etc:
